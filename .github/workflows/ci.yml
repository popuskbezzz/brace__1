name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    name: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: pip install poetry==1.8.3

      - name: Cache Poetry artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            packages/backend/.venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('packages/backend/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-

      - name: Configure Poetry
        working-directory: packages/backend
        run: poetry config virtualenvs.in-project true

      - name: Install backend lint deps
        working-directory: packages/backend
        run: poetry install --no-root --only dev

      - name: Ruff lint (backend)
        working-directory: packages/backend
        run: poetry run ruff check . --output-format=github

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Restore frontend node_modules cache
        id: frontend-cache
        uses: actions/cache@v4
        with:
          path: packages/frontend/node_modules
          key: ${{ runner.os }}-frontend-${{ hashFiles('packages/frontend/package-lock.json') }}

      - name: Install frontend deps (typecheck)
        if: steps.frontend-cache.outputs.cache-hit != 'true'
        working-directory: packages/frontend
        run: npm ci

      - name: TypeScript typecheck (npm run typecheck)
        working-directory: packages/frontend
        env:
          FORCE_COLOR: '1'
        run: |
          if [ ! -d node_modules ]; then
            npm ci
          fi
          npm run typecheck -- --pretty false

  backend:
    runs-on: ubuntu-latest
    needs: quality
    services:
      postgres:
        image: postgres:13
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Cache Poetry artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            packages/backend/.venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('packages/backend/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-
      - name: Configure Poetry
        working-directory: packages/backend
        run: poetry config virtualenvs.in-project true
      - name: Install backend deps
        working-directory: packages/backend
        run: poetry install --no-root
      - name: Prepare test database
        env:
          PGPASSWORD: postgres
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do sleep 1; done
          psql -h localhost -U postgres -c "DROP DATABASE IF EXISTS brace_test;"
          psql -h localhost -U postgres -c "CREATE DATABASE brace_test;"
      - name: Test backend
        working-directory: packages/backend
        env:
          TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/brace_test
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/brace_test
        run: poetry run pytest --maxfail=1 --disable-warnings -q
      - name: Export deps for pip-audit
        working-directory: packages/backend
        run: poetry export -f requirements.txt --without-hashes -o /tmp/requirements.txt
      - name: Pip audit
        run: |
          python -m pip install --upgrade pip pip-audit
          pip-audit -r /tmp/requirements.txt
        # PRINCIPAL-NOTE: pip-audit gates known CVEs before we ship.
      - name: Regenerate OpenAPI spec
        working-directory: packages/backend
        env:
          BRACE_TELEGRAM_BOT_TOKEN: test-token
        run: |
          poetry run python - <<'PY'
          from pathlib import Path
          import yaml
          from brace_backend.main import app
          spec = app.openapi()
          Path('openapi.yaml').write_text(yaml.safe_dump(spec, sort_keys=False), encoding='utf-8')
          PY
      - name: Verify OpenAPI spec committed
        run: git diff --exit-code packages/backend/openapi.yaml
        # PRINCIPAL-NOTE: Prevents drift between backend code and the published contract.

  frontend:
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install deps
        working-directory: packages/frontend
        run: npm ci
      - name: Lint
        working-directory: packages/frontend
        run: npm run lint
      - name: Build
        working-directory: packages/frontend
        run: npm run build
      - name: npm audit
        working-directory: packages/frontend
        run: npm audit --audit-level=high
        # PRINCIPAL-NOTE: npm audit enforces security fixes for shipped bundles.
      - name: Verify generated API types
        run: |
          bash packages/frontend/scripts/generate-api.sh
          git diff --exit-code packages/frontend/src/shared/api/generated.ts
        # PRINCIPAL-NOTE: Frontend contracts stay in sync with backend OpenAPI.

  docker-build:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    # PRINCIPAL-NOTE: Containers are only built once lint/tests succeed.
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build backend image
        run: docker build -f packages/backend/Dockerfile -t ghcr.io/${{ github.repository }}/backend:latest .
      - name: Build frontend image
        run: docker build -f packages/frontend/Dockerfile -t ghcr.io/${{ github.repository }}/frontend:latest .
      - name: Push images
        if: github.ref == 'refs/heads/main'
        run: |
          docker push ghcr.io/${{ github.repository }}/backend:latest
          docker push ghcr.io/${{ github.repository }}/frontend:latest

  smoke-tests:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    env:
      BRACE_TELEGRAM_BOT_TOKEN: smoke-ci-token
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: brace
    steps:
      - uses: actions/checkout@v4
      - name: Run docker compose smoke tests
        run: docker compose -f infra/docker-compose.prod.yml --profile smoke up --build --abort-on-container-exit --exit-code-from smoke-tests
        # PRINCIPAL-NOTE: Full stack smoke profile prevents regressions in CI artifacts.
      - name: Teardown
        if: always()
        run: docker compose -f infra/docker-compose.prod.yml --profile smoke down --volumes --remove-orphans

  trivy-scan:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          ignore-unfixed: true
        # PRINCIPAL-NOTE: Trivy catches leaked secrets and CVEs in the repo before deploys.

  deploy:
    runs-on: ubuntu-latest
    needs: [docker-build, smoke-tests, trivy-scan]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Configure Poetry
        working-directory: packages/backend
        run: poetry config virtualenvs.in-project true
      - name: Install backend deploy deps
        working-directory: packages/backend
        run: poetry install --only main --no-root
      - name: Run Alembic migrations
        working-directory: packages/backend
        env:
          ALEMBIC_DATABASE_URL: ${{ secrets.ALEMBIC_DATABASE_URL }}
        run: |
          if [ -z "$ALEMBIC_DATABASE_URL" ]; then
            echo "ALEMBIC_DATABASE_URL secret must be set for deploy migrations." >&2
            exit 1
          fi
          poetry run alembic upgrade head
      - name: Render deploy hook (placeholder)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            curl -X POST "$RENDER_DEPLOY_HOOK"
          else
            echo 'RENDER_DEPLOY_HOOK not set, skipping.'
          fi
